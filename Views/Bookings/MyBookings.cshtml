@model IEnumerable<TravelAgency.Models.Booking>
@using TravelAgency.Models

<h2>My Bookings</h2>

@if (!Model.Any())
{
    <p>No bookings yet.</p>
}
else
{
    <table class="table">
        <thead>
        <tr>
            <th>Trip</th>
            <th>Departure</th>
            <th>Remaining</th>
            <th>Total</th>
            <th>Status</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        @foreach (var b in Model)
        {
            var remainingDays = (b.DepartureDate.Date - DateTime.UtcNow.Date).Days;
            <tr>
                <td>
                    <a asp-action="Details" asp-route-id="@b.Id" class="text-decoration-none fw-semibold">
                        @b.TravelPackage.Name
                    </a>
                </td>
                <td>@b.DepartureDate.ToString("dd MMM yyyy")</td>
                <td>
                    @if (remainingDays >= 0) { <span>@remainingDays days</span> }
                    else { <span class="text-muted">Past</span> }
                </td>
                <td>â‚¬@b.TotalPrice</td>
                <td>
                    <span class="badge
                        @(b.Status == BookingStatus.Confirmed ? "bg-success" :
                          b.Status == BookingStatus.PendingPayment ? "bg-warning text-dark" :
                          "bg-secondary")">
                        @b.Status
                    </span>
                </td>
                <td class="text-end">
                    @if (b.Status == BookingStatus.PendingPayment)
                    {
                        <a asp-controller="Payments" asp-action="Pay" asp-route-bookingId="@b.Id"
                           class="btn btn-sm btn-danger">Pay</a>
                        <form asp-action="Cancel" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@b.Id" />
                            <button class="btn btn-sm btn-outline-danger">Cancel</button>
                        </form>
                    }
                    else if (b.Status == BookingStatus.Confirmed && DateTime.Today <= b.CancellationAllowedUntil.Date)
                    {
                        <form asp-action="Cancel" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@b.Id" />
                            <button class="btn btn-sm btn-outline-danger">Cancel</button>
                        </form>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
}
